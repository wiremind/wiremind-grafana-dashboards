#!/bin/bash

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if the target file is staged
for TARGET_FILE in $STAGED_FILES; do
  # Only process YAML files
  if [[ "$TARGET_FILE" == *.yaml || "$TARGET_FILE" == *.json ]]; then
    # Replace specific datasource placeholders with generic ${datasource}
    # Cross-platform sed in-place editing
    if [[ "$OSTYPE" == "darwin"* ]]; then
      # macOS/BSD sed
      sed -i '' 's/\${DS_PROMETHEUS}/\${datasource}/g' "$TARGET_FILE"
      sed -i '' 's/\${DS_THANOS}/\${datasource}/g' "$TARGET_FILE"
    else
      # GNU sed (Linux)
      sed -i 's/\${DS_PROMETHEUS}/\${datasource}/g' "$TARGET_FILE"
      sed -i 's/\${DS_THANOS}/\${datasource}/g' "$TARGET_FILE"
    fi

    git add "$TARGET_FILE"
  fi
done
